#!/usr/bin/env bash

#: exec_target = cli

## Initialize an AI assistant.
##
## Usage: fin init-ai

# Abort if anything fails
set -e

#-------------------------- Settings --------------------------------

CONFIGURED_AI="$AI_ASSISTANT"
JSON_FILE="${PROJECT_ROOT}/.docksal/config/ai/ai-assistants.json"

#-------------------------- END: Settings --------------------------------

#-------------------------- Helper functions --------------------------------

# Console colors
red='\033[0;31m'
green='\033[0;32m'
green_bg='\033[1;97;42m'
yellow='\033[1;33m'
NC='\033[0m'

echo-red () { echo -e "${red}$1${NC}"; }
echo-green () { echo -e "${green}$1${NC}"; }
echo-green-bg () { echo -e "${green_bg}$1${NC}"; }
echo-yellow () { echo -e "${yellow}$1${NC}"; }

#-------------------------- END: Helper functions --------------------------------

#-------------------------- Functions --------------------------------

init_ai ()
{
  # Read rulesdir and type from JSON
  read -r RULESDIR TYPE < <(jq -r --arg id "$CONFIGURED_AI" '
    .assistants[]
    | select(.id == $id)
    | "\(.rulesdir) \(.type)"
  ' "$JSON_FILE")

  if [[ -z "$RULESDIR" || "$RULESDIR" == "null" ]]; then
    echo-yellow "Error: No documented rulesdir for AI assistant '$CONFIGURED_AI'"
    exit 1
  fi

  # Ensure parent directory exists
  mkdir -p "$(dirname "$RULESDIR")"

  # Determine relative symlink target from the assistant path
  if [[ "$TYPE" == "file" ]]; then
    TARGET="$(realpath --relative-to="$(dirname "$RULESDIR")" "${PROJECT_ROOT}/.ai/rules/rules.md")"
  else
    TARGET="$(realpath --relative-to="$(dirname "$RULESDIR")" "${PROJECT_ROOT}/.ai/rules")"
  fi

  # Remove old symlink or file if it exists
  if [[ -L "$RULESDIR" || -e "$RULESDIR" ]]; then
    rm -rf "$RULESDIR"
  fi

  # Create the symlink
  ln -s "$TARGET" "$RULESDIR"

  echo-green "Symlink created: $RULESDIR -> $TARGET"
}

#-------------------------- END: Functions --------------------------------

#-------------------------- Execution --------------------------------

if [[ -z "${AI_ASSISTANT:-}" ]]; then
  echo-yellow "Error: AI_ASSISTANT environment variable is not set."
  exit 1
fi

# Project initialization steps
time -p init_ai

#-------------------------- END: Execution --------------------------------
